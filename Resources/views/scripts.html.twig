<script type="text/javascript">
function createPmMessage() {
    $( "#createpm" ).dialog("open");
    return false;
}

function checkUnread() {
    $.ajax({
        beforeSend: function(req) {
          req.setRequestHeader("Accept", "application/json");
        },
        type: "GET",
        url: "{{ path('check_unread', { 'access': 'ajax' }) }}",
        dataType: "json",
        async: true,
      }).done( function( cont, textStatus, xhr ) {
          if (cont === true) {
              $( "#message_menu" ).children().css("color","red");
              $( "#menu_unread" ).show();
          } else {
            setTimeout ( "checkUnread()", 60000 );
          }
      });
    return false;
}

function submitPmMessageForm() {
    formdata = $( "#createpmform" ).serialize();
    $.ajax({
        beforeSend: function(req) {
          req.setRequestHeader("Accept", "application/json");
        },
        type: "POST",
        url: "{{ path('pm_create', { 'access': 'ajax' }) }}",
        data: $( "#createpmform" ).serialize(),
        dataType: "text",
        async: true,
      }).done( function( cont, textStatus, xhr ) {
            $( "#createpm" ).dialog("close");
      }).fail(function(xhr, status, error) {
            errmsg = "Message sending failed\n";
            errmsg = errmsg + xhr.responseText + "\n";
            alert(errmsg);
    });
    return false;
}

jQuery(document).ready(function() {
    $( "#createpm" ).dialog({
      autoOpen: false,
      height: 300,
      width: 400,
      modal: true
    });
    $( "#menu_unread" ).hide();
    checkUnread();
});

</script>

<script>
$( function() {
$( "#message_data_to" ).autocomplete({
  source: "{{ path('user_search', {'access': 'ajax'}) }}",
  minlength: 4,
  select: function( event, ui ) {
    $( "#message_data_to" ).val(ui.item.value);
    $( "#to_userid" ).val(ui.item.userid);
    $( "#message_data_body" ).focus();
  }
});
} );
</script>

<div id="createpm" title="Write a PM">
{# Gotta remember to add some way to send "in_reply_to" here. #}
{% set pmform = sakonnin.getCreatePmForm({'create_view': true}) %}
<form id="createpmform" method="POST" action="{{ path('pm_create', { 'access': 'ajax' }) }}" onSubmit="return submitPmMessageForm();">
<input type="hidden" name="to_userid" id="to_userid">
{{ form_row(pmform.subject)}} 
{{ form_row(pmform.to)}} 
{{ form_row(pmform.body)}} 
{{ form_row(pmform.submit)}} 
{{ form_row(pmform._token)}} 
</div>
</form>
